machine:
  services:
    - docker

dependencies:
  post:
    - wget https://download.elastic.co/elasticsearch/release/org/elasticsearch/distribution/tar/elasticsearch/2.4.0/elasticsearch-2.4.0.tar.gz
    - tar -xzvf elasticsearch-2.4.0.tar.gz
    - elasticsearch-2.4.0/bin/elasticsearch: {background: true}
    - npm install -g elm

    # Hack :)
    # Compiling Elm assets from scratch when building the docker image takes ~15 minutes.
    # To avoid this wait time every time we build the image, we compile assets here, cache
    # compiled dependencies and then tell the docker build to skip assets compilation.
    - bundle exec rake assets:precompile RAILS_ENV=production SECRET_KEY_BASE=secret:
        timeout: 1200
  cache_directories:
    - "elm-stuff/build-artifacts"

deployment:
  docker-main:
    branch:
      - master
      - stable
    owner: instedd
    commands:
      - ./docker/deploy.sh ${CIRCLE_BRANCH/#master/latest}
  docker-tag:
    tag: /[0-9]+(\.[0-9]+)*(-pre\d+)?/
    owner: instedd
    commands:
      - ./docker/deploy.sh ${CIRCLE_TAG}
